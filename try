#!/bin/bash

CFLAGS=-ggdb make || exit $?

HOST="`hostname`"
if [ "${HOST#kudos-}" == "$HOST" -a "$HOST" != "execl" ]
then
	echo "Not running on a kudos-* test machine, won't overwrite your file systems."
	exit 1
fi

echo -n "Creating file system... "
sudo mke2fs -m 0 -b 4096 /dev/sdb1 &> /dev/null
sudo mount /dev/sdb1 /mnt/test -t ext2
sudo chown `whoami` /mnt/test
cat > /mnt/test/run << EOF
journal create tj
journal append record1
journal append record2
journal commit
journal playback
journal erase
tx
str_tbl
dtable
ctable
stable
EOF
mkdir /mnt/test/journals
sudo umount /mnt/test
echo "done."

echo -n "Loading Featherstitch... "
sudo insmod fstitch/kfstitchd.ko device=/dev/sdb
[ -f /proc/kfstitchd_debug ] && (cat /proc/kfstitchd_debug > try.fdb &) || rm -f try.fdb
sudo mount /mnt/test
echo "done."

#export VALGRIND="valgrind --trace-children=yes"
echo "script run" | (WD="`pwd`"; cd /mnt/test; ulimit -c unlimited; exec $VALGRIND "$WD/toilet")

ls -lR /mnt/test
true | hexdump -C /mnt/test/teststrings
true | hexdump -C /mnt/test/sys_journal
true | hexdump -C /mnt/test/managed_dtable/md_meta
true | hexdump -C /mnt/test/managed_dtable/md_data.2
true | hexdump -C /mnt/test/managed_ctable/md_data.1

echo "Unloading Featherstitch... "
sudo umount /mnt/test
sudo rmmod kfstitchd
echo "done."

sudo mount /dev/sdb1 /mnt/test -t ext2
if [ -f /mnt/test/core ]
then
	echo "Starting debugger on core."
	gdb -c /mnt/test/core main
fi
sudo umount /mnt/test

#dmesg | tail -n 30
